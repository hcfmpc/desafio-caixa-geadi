# Controle de Arquivos GEADI

API para controle de arquivos e lotes do sistema GEADI desenvolvida em .NET 8.0.

## üìã Pr√©-requisitos

### Op√ß√£o 1: Docker (Recomendado)
- **Docker Desktop** - [Download aqui](https://www.docker.com/products/docker-desktop/)
- **.NET 8.0 SDK** - [Download aqui](https://dotnet.microsoft.com/download/dotnet/8.0) (para migrations)
- **PowerShell** (para scripts de automa√ß√£o)
- **Gi‚îú‚îÄ‚îÄ Scripts/                      # üîß Scripts de automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ verify.ps1                # Verifica√ß√£o de depend√™ncias
‚îÇ   ‚îú‚îÄ‚îÄ setup-env.ps1             # Configura√ß√£o autom√°tica
‚îÇ   ‚îú‚îÄ‚îÄ env-utils.ps1             # Fun√ß√µes utilit√°rias e seguran√ßa
‚îÇ   ‚îú‚îÄ‚îÄ start_full_docker.ps1     # Cen√°rio 1: Tudo Docker
‚îÇ   ‚îú‚îÄ‚îÄ start_apiDotnet_dbDocker.ps1  # Cen√°rio 2: API local + DB Docker
‚îÇ   ‚îî‚îÄ‚îÄ start_apiDotnet_dbServer.ps1  # Cen√°rio 3: API local + DB servidorpara clonar o reposit√≥rio)

### Op√ß√£o 2: Desenvolvimento Local
- **.NET 8.0 SDK** - [Download aqui](https://dotnet.microsoft.com/download/dotnet/8.0)
- **SQL Server** (Express, LocalDB ou Docker)
- **Git** (para clonar o reposit√≥rio)

## üöÄ Instala√ß√£o R√°pida (Docker)

### 1. Clone o reposit√≥rio
```powershell
git clone https://github.com/hcfmpc/desafio-caixa-geadi.git
cd desafio-caixa-geadi
```

### 2. Configurar ambiente (autom√°tico)
```powershell
# Detecta automaticamente o caminho do projeto
.\Scripts\setup-env.ps1
```

### 3. Verificar depend√™ncias
```powershell
.\Scripts\verify.ps1
```

### 4. Iniciar aplica√ß√£o
```powershell
# Subir containers (API + Banco)
docker-compose up -d

# Criar banco de dados (apenas primeira vez)
docker exec -it geadi-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "Ge@di2024" -C -Q "CREATE DATABASE DBGEADI"

# Aplicar migrations (apenas primeira vez)
cd ControleArquivosGEADI.API
dotnet tool install --global dotnet-ef
dotnet ef database update
cd ..
```

### 5. Acessar aplica√ß√£o
- **API**: http://localhost:8080
- **Swagger UI**: http://localhost:8080/swagger
- **SQL Server**: localhost:1433 (sa/Ge@di2024)

## ‚ö° Scripts de Inicializa√ß√£o

### Op√ß√£o 1: Inicializa√ß√£o R√°pida (Recomendado)
```powershell
# Inicializa√ß√£o otimizada (~15 segundos)
.\Scripts\quick-start.ps1
```

### Op√ß√£o 2: Inicializa√ß√£o Completa
```powershell
# Executa: verifica√ß√£o + docker-compose + migrations + banco
.\Scripts\start.ps1
```

### Op√ß√£o 3: Desenvolvimento H√≠brido (SQL no Docker + API Local)
```powershell
# Inicia apenas SQL Server
docker-compose up -d sqlserver

# Em outro terminal, executar API localmente:
dotnet run --project ControleArquivosGEADI.API
# API dispon√≠vel em: http://localhost:8080
```

### Op√ß√£o 4: Script H√≠brido Automatizado  
```powershell
# Inicia apenas SQL Server para desenvolvimento
.\Scripts\start-sql-only.ps1

# Em outro terminal:
dotnet run --project ControleArquivosGEADI.API
```

### Op√ß√£o 5: Docker Manual
```powershell
# Para usu√°rios que preferem controle manual
docker-compose up -d
# Nota: SQL Server pode demorar 60+ segundos para inicializar
```

## üîß Configura√ß√£o Personalizada

### Configura√ß√£o Autom√°tica (Recomendado)
O script `setup-env.ps1` detecta automaticamente o caminho do projeto e configura o ambiente.

### Configura√ß√£o Manual
Caso precise ajustar manualmente:

1. **Copie o arquivo de exemplo:**
```powershell
cp .env.example .env
```

2. **Edite o arquivo `.env`:**
```bash
# Ajuste o caminho para sua m√°quina
PROJECT_ROOT=C:/SeuCaminho/desafio-caixa-geadi
```

3. **Exemplos de caminhos:**
```bash
# Windows
PROJECT_ROOT=C:/Users/SeuUsuario/projetos/desafio-caixa-geadi
PROJECT_ROOT=D:/desenvolvimento/caixa/desafio-caixa-geadi

# Linux/Mac  
PROJECT_ROOT=/home/usuario/projetos/desafio-caixa-geadi
PROJECT_ROOT=/Users/usuario/desenvolvimento/desafio-caixa-geadi
```

## üõ†Ô∏è Cen√°rios de Desenvolvimento

Escolha o script que melhor se adapta ao seu ambiente:

### üê≥ **Cen√°rio 1: Tudo Docker** (Produ√ß√£o/Demonstra√ß√£o)
```powershell
.\Scripts\start_full_docker.ps1
```
**Quando usar:**
- ‚úÖ Demonstra√ß√µes e testes finais
- ‚úÖ Ambiente id√™ntico √† produ√ß√£o
- ‚úÖ Setup sem depend√™ncias locais

**O que faz:**
- Inicia SQL Server + API em containers
- Configura ambiente automaticamente
- Aplica migrations e testa conectividade

---

### üèóÔ∏è **Cen√°rio 2: API Local + Banco Docker** (Desenvolvimento)
```powershell
.\Scripts\start_apiDotnet_dbDocker.ps1
```
**Quando usar:**
- ‚úÖ **Recomendado para desenvolvimento**
- ‚úÖ Debugging completo com breakpoints
- ‚úÖ Hot reload durante codifica√ß√£o

**O que faz:**
- Inicia apenas SQL Server no Docker
- Roda API localmente via `dotnet run`
- Permite debugging completo no VS Code

---

### üéØ **Cen√°rio 3: API Local + Banco Servidor** (Corporativo)
```powershell
.\Scripts\start_apiDotnet_dbServer.ps1
```
**Quando usar:**
- ‚úÖ Banco SQL Server j√° dispon√≠vel na rede
- ‚úÖ Ambientes corporativos com BD centralizado
- ‚úÖ Desenvolvimento com dados reais

**O que faz:**
- Conecta no banco configurado em `appsettings.json`
- Valida conectividade antes de iniciar
- Roda API localmente para debugging

---

### ‚öôÔ∏è **Configura√ß√£o Manual** (Avan√ßado)

#### Para configurar manualmente:

##### 1. Configurar ambiente
```powershell
# Apenas se necess√°rio configurar caminhos
.\Scripts\setup-env.ps1
```

##### 2. Iniciar componentes individuais
```powershell
# Apenas SQL Server no Docker
docker-compose up -d sqlserver

# Apenas API local
cd ControleArquivosGEADI.API
dotnet run --urls "http://localhost:8080"
```

##### 3. Aplicar migrations manualmente
```powershell
cd ControleArquivosGEADI.API
dotnet ef database update
```

## üìä Banco de Dados

### Estrutura das Tabelas
A aplica√ß√£o cria automaticamente as seguintes tabelas:
- `aditb001_controle_arquivos` - Controle de arquivos capturados
- `aditb002_lote_arquivos` - Lotes de processamento de arquivos  
- `aditb003_base_mensal_ETL` - Base mensal para processamento ETL

### Inicializa√ß√£o do Banco

#### Op√ß√£o 1: Banco Vazio (Padr√£o)
Ap√≥s seguir os passos de instala√ß√£o, o banco ser√° criado com as tabelas vazias, pronto para receber dados via API.

#### Op√ß√£o 2: Testar Rota ETLBaseMensal
Use a API normalmente e envie o arquivo `BASE_MENSAL.csv` via endpoint ETLBaseMensal para testar a funcionalidade.

## üß™ Testes Isolados de Banco de Dados

### Cen√°rio: Testar Inser√ß√£o Direta no Banco (Sem API)
Caso queira verificar se o banco consegue receber dados sem usar a API:

```powershell
# Para testar inser√ß√£o direta no SQL Server
.\database\script-manual\import_ETL_BASE_MENSAL.ps1
```

**Quando usar:**
- ‚úÖ Debugging de problemas de conex√£o com banco
- ‚úÖ Testar performance de inser√ß√£o isoladamente  
- ‚úÖ Verificar se migrations foram aplicadas corretamente
- ‚ùå **N√ÉO usar para inicializa√ß√£o normal da aplica√ß√£o**

**Dados importados:**
- Tabela: `aditb003_base_mensal_ETL`
- Fonte: `database/massa-de-teste-db/BASE_MENSAL.csv`
- Registros: 100.000 linhas com dados simulados

### Persist√™ncia de Dados

#### ‚úÖ **Dados Persistem ao Parar/Reiniciar**
```powershell
# Parar aplica√ß√£o
docker-compose down

# Reiniciar aplica√ß√£o  
docker-compose up -d
# ‚úÖ Todos os dados permanecem intactos
```

#### ‚ùå **Remover Dados Permanentemente**
```powershell
# Apagar dados e volumes
docker-compose down -v
# ‚ö†Ô∏è CUIDADO: Remove TODOS os dados do banco
```

#### üìä **Verificar Dados Ap√≥s Reinicializa√ß√£o**
A aplica√ß√£o mant√©m todos os dados ap√≥s reinicializa√ß√£o. Para verificar, acesse:
- **Swagger UI**: http://localhost:8080/swagger  
- **Endpoint**: GET `/arquivos` para ver arquivos mapeados

## üè¢ Usando SQL Server Externo

### Configura√ß√£o para Servidor Pr√≥prio

#### 1. Preparar Servidor SQL
- ‚úÖ SQL Server 2019 ou superior
- ‚úÖ Autentica√ß√£o SQL habilitada
- ‚úÖ Usu√°rio com permiss√µes de `db_owner`

#### 2. Configurar Connection String
Edite o arquivo `ControleArquivosGEADI.API/appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=SEU_SERVIDOR;Initial Catalog=DBGEADI;User ID=seu_usuario;Password=sua_senha;Connect Timeout=30;Encrypt=True;TrustServerCertificate=True;"
  }
}
```

#### 3. Aplicar Migrations
```powershell
cd ControleArquivosGEADI.API
dotnet ef database update
cd ..
```

**‚úÖ O que as Migrations fazem automaticamente:**
- Criam o banco `DBGEADI` se n√£o existir
- Criam todas as 3 tabelas necess√°rias
- Aplicam √≠ndices e constraints
- Configuram relacionamentos entre tabelas

**üìã N√£o √© necess√°rio:**
- Executar scripts SQL manualmente
- Criar tabelas previamente
- Configurar esquemas ou usu√°rios especiais

#### 4. Executar Aplica√ß√£o
```powershell
# Desenvolvimento local
dotnet run

# Ou via Docker (apontando para servidor externo)
docker-compose up -d api
```

## üåê Endpoints Principais

- `GET /arquivos` - Listar arquivos
- `GET /arquivos/{id}` - Buscar arquivo por ID
- `GET /lotes` - Listar lotes
- `GET /lotes/{id}` - Buscar lote por ID
- `POST /mapearpasta` - Mapear arquivos de pasta
- `POST /etlbasemensal` - Processar ETL base mensal

## üîß Comandos √öteis

### Gerenciamento Docker
```powershell
# Ver status dos containers
docker ps

# Ver logs da API
docker-compose logs api

# Ver logs do banco
docker-compose logs sqlserver

# Parar aplica√ß√£o
docker-compose down

# Rebuild completo
docker-compose up --build

# Limpar volumes (apaga dados do banco)
docker-compose down -v
```

### Scripts Utilit√°rios
```powershell
# Verificar depend√™ncias
.\Scripts\verify.ps1

# Inicializa√ß√£o r√°pida (~15 segundos)
.\Scripts\quick-start.ps1

# Inicializa√ß√£o completa automatizada
.\Scripts\start.ps1
```

## ‚è±Ô∏è Compara√ß√£o de Performance

| M√©todo | Tempo | Descri√ß√£o |
|--------|-------|-----------|
| `.\quick-start.ps1` | ~15 segundos | ‚ö° Otimizado, inicia SQL primeiro |
| `.\start.ps1` | ~30 segundos | üîÑ Completo com todas verifica√ß√µes |
| `docker-compose up -d` | 60+ segundos | üêå Aguarda health check do SQL |

## üêõ Solu√ß√£o de Problemas

### ‚ùå SQL Server demora muito
```powershell
# Use o script otimizado
.\Scripts\quick-start.ps1

# Ou inicie SQL Server separadamente
docker-compose up -d sqlserver
# Aguarde ~10 segundos
docker-compose up -d api
```

### Banco n√£o conecta
```powershell
# Verificar se SQL Server est√° rodando
docker ps

# Verificar logs do banco
docker logs geadi-sqlserver

# Testar conex√£o via API
curl http://localhost:8080/arquivos
```

### Swagger n√£o aparece
- Verifique se `ASPNETCORE_ENVIRONMENT=Development` no docker-compose.yml
- Acesse: http://localhost:8080/swagger (n√£o https)
- Aguarde alguns segundos para a API inicializar

### Porta ocupada
```powershell
# Windows - verificar processo na porta 8080
netstat -ano | findstr :8080

# Parar containers e tentar novamente
docker-compose down
docker-compose up -d
```

### Problemas com dados de teste
```powershell
# Verificar se containers est√£o funcionando
docker ps

# Verificar conex√£o com banco
.\Scripts\check-data.ps1
```

## üìÅ Estrutura do Projeto

```
desafio-caixa-geadi/
‚îú‚îÄ‚îÄ ControleArquivosGEADI.API/    # üöÄ Projeto principal da API
‚îÇ   ‚îú‚îÄ‚îÄ DbContexts/               # Contextos Entity Framework
‚îÇ   ‚îú‚îÄ‚îÄ EndpointHandlers/         # Handlers dos endpoints
‚îÇ   ‚îú‚îÄ‚îÄ Models/                   # Modelos de dados
‚îÇ   ‚îî‚îÄ‚îÄ Migrations/               # Migra√ß√µes do banco
‚îú‚îÄ‚îÄ Scripts/                      # üîß Scripts de automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ verify.ps1                # Verifica√ß√£o de depend√™ncias
‚îÇ   ‚îú‚îÄ‚îÄ setup-env.ps1             # Configura√ß√£o autom√°tica
‚îÇ   ‚îú‚îÄ‚îÄ env-utils.ps1             # Fun√ß√µes utilit√°rias e seguran√ßa
‚îÇ   ‚îú‚îÄ‚îÄ start_full_docker.ps1     # Cen√°rio 1: Tudo Docker
‚îÇ   ‚îú‚îÄ‚îÄ start_apiDotnet_dbDocker.ps1  # Cen√°rio 2: API local + DB Docker
‚îÇ   ‚îú‚îÄ‚îÄ start_apiDotnet_dbServer.ps1  # Cen√°rio 3: API local + DB servidor
‚îÇ   ‚îî‚îÄ‚îÄ ARQUITETURA_SCRIPTS.md    # Documenta√ß√£o detalhada dos scripts
‚îú‚îÄ‚îÄ database/                     # üóÑÔ∏è Scripts e dados para desenvolvimento
‚îÇ   ‚îú‚îÄ‚îÄ script-manual/            # Script de teste do banco
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ import_ETL_BASE_MENSAL.ps1  # Teste isolado do banco
‚îÇ   ‚îú‚îÄ‚îÄ massa-de-teste-db/        # Dados CSV para rota ETLBaseMensal
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml       # Configura√ß√£o SQL Server
‚îú‚îÄ‚îÄ .env                          # üîí Vari√°veis de ambiente (credenciais)
‚îú‚îÄ‚îÄ Dockerfile                    # üê≥ Configura√ß√£o Docker da aplica√ß√£o
‚îú‚îÄ‚îÄ docker-compose.yml           # üéØ Orquestra√ß√£o dos servi√ßos
‚îî‚îÄ‚îÄ README.md                    # üìñ Esta documenta√ß√£o
```

## üìã Scripts Dispon√≠veis

| Script | Tempo | Prop√≥sito | Quando Usar |
|--------|-------|-----------|-------------|
| `Scripts\verify.ps1` | ~5s | Verifica depend√™ncias (Docker/.NET) | Antes de iniciar |
| `Scripts\setup-env.ps1` | ~1s | Configura ambiente automaticamente | Primeira vez |
| `Scripts\start_full_docker.ps1` | ~30s | Tudo Docker (API + DB) | ‚≠ê **Produ√ß√£o/Demo** |
| `Scripts\start_apiDotnet_dbDocker.ps1` | ~20s | API local + DB Docker | ‚≠ê **Desenvolvimento** |
| `Scripts\start_apiDotnet_dbServer.ps1` | ~15s | API local + DB servidor | **Corporativo** |

### üîí **Seguran√ßa Implementada**
- **Credenciais via .env**: Todas as senhas v√™m exclusivamente do arquivo `.env`
- **Valida√ß√£o obrigat√≥ria**: Scripts falham se vari√°veis est√£o ausentes
- **Output mascarado**: Credenciais nunca aparecem nos logs (`user/***`)
- **Sem hardcoding**: Zero credenciais no c√≥digo fonte

## üéØ Fluxos Recomendados

### üöÄ **Desenvolvimento R√°pido**
```powershell
.\Scripts\start_apiDotnet_dbDocker.ps1  # 20s - API local + DB Docker (recomendado)
```

### üîç **Primeira Vez/Troubleshooting** 
```powershell
.\Scripts\verify.ps1                    # 5s  - Verificar depend√™ncias
.\Scripts\start_full_docker.ps1         # 30s - Inicializa√ß√£o completa
```

### üè¢ **Ambiente Corporativo**
```powershell
# 1. Configure appsettings.json com seu servidor SQL
# 2. Execute:
.\Scripts\start_apiDotnet_dbServer.ps1   # 15s - API local + servidor
```

## üîÑ Gerenciamento de Dados

### **Parar/Reiniciar (Dados Persistem)**
```powershell
docker-compose down    # Parar containers
docker-compose up -d   # Reiniciar containers
# ‚úÖ Dados permanecem intactos no volume Docker
```

### **Reset Completo (Remove Tudo)**
```powershell
docker-compose down -v # Remover containers + volumes
.\Scripts\start_full_docker.ps1         # Reconstruir do zero
```

## üè∑Ô∏è Tecnologias

- **.NET 8.0** - Framework principal
- **Entity Framework Core** - ORM
- **SQL Server 2022** - Banco de dados
- **Docker** - Containeriza√ß√£o
- **Swagger/OpenAPI** - Documenta√ß√£o da API
- **AutoMapper** - Mapeamento de objetos

## üìù Notas Importantes

- O Swagger s√≥ funciona em ambiente `Development`
- **Credenciais de desenvolvimento**: Definidas no arquivo `.env` (n√£o hardcoded)
- **Seguran√ßa**: Scripts validam vari√°veis obrigat√≥rias e mascaram credenciais no output
- Os dados ficam persistidos no volume Docker `sqlserver_data`
- Para produ√ß√£o, considere usar Docker Secrets para senhas
- **env-utils.ps1**: Fornece fun√ß√µes seguras para gerenciamento de credenciais